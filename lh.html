<!DOCTYPE html>
<html>
<head>
  <title>HTML Loader</title>
</head>
<body>
  <div id="loader">Loading page...</div>

<script>
  function fromBase64Unicode(b64) {
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    try { return new TextDecoder('utf-8').decode(bytes); } catch (_) { return decodeURIComponent(escape(bin)); }
  }

  const params = new URLSearchParams(window.location.search);
  const htmlFile = params.get('unique_id');
  if (!htmlFile) {
    document.getElementById('loader').innerText = 'Error: No unique_id provided.';
  } else {
    const apiUrl =
      'https://app.base44.com/api/apps/6812ad73a9594a183279deba/entities/DataRecord' +
      '?user_id=user_jveo8b35q_1748241619184' +
      '&payload.unique_id=' + encodeURIComponent(htmlFile);

    fetch(apiUrl, {
      headers: { api_key: '69315aa5aa7f4b6fa99c7a420da68bdd', 'Content-Type': 'application/json' }
    })
      .then(r => r.json())
		.then(records => {
		  if (!records || !records.length) throw new Error('HTML not found.');
		  const htmlCode = fromBase64Unicode(records[0].payload.file_content);

		  // --- Option 1: copy favicon / apple-touch icons / theme-color from fetched HTML into loader head
		  const parser = new DOMParser();
		  const fetchedDoc = parser.parseFromString(htmlCode, 'text/html');

		  (function copyFavicons(srcDoc) {
			const selectors = 'link[rel*="icon"], link[rel="shortcut icon"], link[rel^="apple-touch"], meta[name="theme-color"], meta[name="msapplication-TileColor"], meta[name="msapplication-TileImage"]';
			// remove existing matches so we don't duplicate
			document.head.querySelectorAll(selectors).forEach(el => el.remove());
			// clone & append favicon/meta nodes from fetched HTML head
			srcDoc.head.querySelectorAll(selectors).forEach(el => document.head.appendChild(el.cloneNode(true)));
		  })(fetchedDoc);

		  // Replace whole document â€” same as i.html approach
		  document.open();
		  document.write(htmlCode);
		  document.close();
		})
      .catch(err => {
        document.getElementById('loader').innerText = `Error loading content: ${err.message || err}`;
        console.error(err);
      });
  }
</script>

</body>
</html>
