(async function () {
  console.log("l.json: Request started...");

  const isScript = !!document.currentScript; // Check if running via <script>
  const scriptSrc = isScript ? document.currentScript.src : window.location.href;
  const uniqueId = new URL(scriptSrc).searchParams.get("unique_id");

  if (!uniqueId) {
    console.error("l.json: No unique_id provided.");
    return;
  }

  const url =
    "https://app.base44.com/api/apps/6812ad73a9594a183279deba/entities/DataRecord" +
    "?user_id=user_jveo8b35q_1748241619184" +
    "&payload.unique_id=" +
    uniqueId;

  try {
    const res = await fetch(url, {
      headers: {
        api_key: "69315aa5aa7f4b6fa99c7a420da68bdd",
        "Content-Type": "application/json",
      },
    });
    const records = await res.json();

    if (!records.length) {
      console.error("l.json: JSON not found for ID", uniqueId);
      return;
    }

    const base64Content = records[0].payload.file_content;
    const decoded = atob(base64Content);
    const jsonObject = JSON.parse(decoded);

    if (isScript) {
      // Script loader mode
      window.jsonData = jsonObject;
      console.log("l.json: JSON object available as window.jsonData");
    } else {
      // Fetch mode: return raw JSON
      const response = new Response(JSON.stringify(jsonObject), {
        headers: { "Content-Type": "application/json" },
      });
      const stream = await response.text();
      document.open();
      document.write(stream);
      document.close();
    }
  } catch (err) {
    console.error("l.json: Failed to fetch or parse JSON.", err);
  }
})();
