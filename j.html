<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>j.html viewer</title>
  <style>
    body {
      font-family: monospace;
      white-space: pre-wrap;
      padding: 1rem;
    }
    img, iframe {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <div id="output">🔄 Loading...</div>

  <script>
    const page = new URLSearchParams(location.search).get("page");
    const apiKey = "4fd12874c15643f395960cfa2d24d1a2";
    const appId = "686424824d7b61721eac3e29";
    const output = document.getElementById("output");

    if (!page) {
      output.textContent = "❌ Missing ?page=FILENAME";
      throw new Error("Missing filename");
    }

    fetch(`https://app.base44.com/api/apps/${appId}/entities/StorageItem`, {
      headers: {
        "api_key": apiKey,
        "Content-Type": "application/json"
      }
    })
    .then(res => res.json())
    .then(data => {
      console.log("Available files:", data.map(f => f.name)); // For debugging
      const file = data.find(f => f.name?.toLowerCase() === page.toLowerCase());
      if (!file) {
        output.textContent = "❌ File not found: " + page;
        return;
      }

      const mime = file.mime_type || "";
      const content = file.content;
      const fileUrl = file.file_url;

      if (content && (mime.includes("text/") || mime.includes("css") || mime.includes("javascript"))) {
        if (mime.includes("html")) {
          const blob = new Blob([content], { type: "text/html" });
          const url = URL.createObjectURL(blob);
          location.href = url;
        } else if (mime.includes("css")) {
          const style = document.createElement("style");
          style.textContent = content;
          document.head.appendChild(style);
          output.textContent = "✅ CSS loaded.";
        } else if (mime.includes("javascript")) {
          const script = document.createElement("script");
          script.textContent = content;
          document.body.appendChild(script);
          output.textContent = "✅ JS loaded.";
        } else {
          output.textContent = content;
        }
      } else if (fileUrl) {
        if (mime.startsWith("image/")) {
          const img = new Image();
          img.src = fileUrl;
          output.innerHTML = "";
          output.appendChild(img);
        } else if (mime === "application/pdf") {
          const iframe = document.createElement("iframe");
          iframe.src = fileUrl;
          iframe.style.width = "100%";
          iframe.style.height = "90vh";
          output.innerHTML = "";
          output.appendChild(iframe);
        } else {
          location.href = fileUrl;
        }
      } else {
        output.textContent = "❌ File has no usable content or URL.";
      }
    })
    .catch(err => {
      output.textContent = "❌ Error: " + err.message;
    });
  </script>
</body>
</html>
