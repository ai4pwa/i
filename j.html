<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>File Viewer</title>
  <style>
    html, body {
      margin: 0; padding: 1rem;
      font-family: monospace;
      background: #fff; color: #000;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="output">Loading...</div>

  <script>
    const page = new URLSearchParams(location.search).get("page");
    const apiKey = "4fd12874c15643f395960cfa2d24d1a2";
    const appId = "686424824d7b61721eac3e29";

    if (!page) {
      document.body.textContent = "❌ Missing ?page=filename.ext";
      throw new Error("Missing file name");
    }

    fetch(`https://app.base44.com/api/apps/${appId}/entities/StorageItem?name=${encodeURIComponent(page)}`, {
      headers: {
        "api_key": apiKey,
        "Content-Type": "application/json"
      }
    })
    .then(res => res.json())
    .then(results => {
      const file = results.find(x => x.name === page);
      if (!file) throw new Error("File not found");

      const mime = file.mime_type || "text/plain";
      const content = file.content;
      const url = file.file_url;

      // Handle text-based files
      if (content && mime.startsWith("text/") || mime.includes("javascript") || mime.includes("json")) {
        const blob = new Blob([content], { type: mime });
        const objectURL = URL.createObjectURL(blob);

        // Inject correct Content-Type using Blob
        if (mime === "text/html") {
          // Replace entire document for HTML
          location.href = objectURL;
        } else if (mime === "text/css") {
          const style = document.createElement("style");
          style.textContent = content;
          document.head.appendChild(style);
          document.body.textContent = "✅ CSS loaded via content";
        } else if (mime.includes("javascript")) {
          const script = document.createElement("script");
          script.textContent = content;
          document.body.appendChild(script);
          document.body.append("✅ JS executed via content");
        } else {
          // Generic text viewer
          document.body.textContent = content;
        }
      }

      // Fallback: Open binary files via file_url
      else if (url) {
        // Render image directly
        if (mime.startsWith("image/")) {
          const img = new Image();
          img.src = url;
          img.style.maxWidth = "100%";
          document.body.innerHTML = "";
          document.body.appendChild(img);
        }
        // Open PDF or download file
        else {
          location.href = url;
        }
      } else {
        throw new Error("No content or file_url available");
      }
    })
    .catch(err => {
      document.body.textContent = "❌ " + err.message;
    });
  </script>
</body>
</html>
